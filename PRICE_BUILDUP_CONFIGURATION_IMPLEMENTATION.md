# Price Build-up Configuration System Implementation\n\n## Overview\n\nThis document outlines the comprehensive implementation of the dynamic price build-up configuration system and station type configuration for the Ghana OMC ERP system. The implementation includes date-based versioning, approval workflows, audit trails, and thread-safe operations with caching optimizations.\n\n## Implementation Summary\n\n### âœ… Completed Features\n\n#### 1. Price Build-up Entities and DTOs\n- **File**: `services/configuration-service/src/configuration/entities/price-buildup.entity.ts`\n- **Features**:\n  - `PriceBuildupVersion` entity with versioning and effective date ranges\n  - `PriceComponent` entity with all Ghana pricing components\n  - `StationTypePricing` entity for station-specific pricing\n  - `PriceBuildupAuditTrail` entity for complete audit tracking\n  - Support for all Ghana fuel types (Petrol, Diesel, LPG, Kerosene, etc.)\n  - All station types (COCO, DOCO, DODO, Industrial, Commercial, Bulk Consumer)\n\n- **File**: `services/configuration-service/src/configuration/dto/price-buildup.dto.ts`\n- **Features**:\n  - Comprehensive DTOs for all CRUD operations\n  - Validation decorators for data integrity\n  - Bulk operation DTOs for Excel upload and batch updates\n  - Price calculation request/response DTOs\n\n#### 2. Extended Configuration Service\n- **File**: `services/configuration-service/src/configuration/services/price-buildup.service.ts`\n- **Features**:\n  - Complete price build-up version management\n  - Real-time price calculation engine\n  - Excel upload and bulk operations\n  - Date-based effective pricing with automatic version transitions\n  - Price history tracking and analysis\n  - Multi-level caching with Redis and local cache\n\n#### 3. Station Type Configuration\n- **File**: `services/configuration-service/src/configuration/services/station-type-config.service.ts`\n- **Features**:\n  - Default configurations for all Ghana station types\n  - Applicable price components per station type\n  - Base dealer margins and transport costs\n  - Regulatory compliance requirements\n  - Product support matrix\n\n#### 4. Price Build-up Component Management\n- **Supported Components**:\n  ```\n  Base Prices:\n  - Ex-Refinery Price\n  - Landed Cost\n  \n  Taxes and Levies:\n  - Energy Debt Recovery Levy\n  - Road Fund Levy\n  - Price Stabilization Levy\n  - Special Petroleum Tax\n  - Fuel Marking Levy\n  \n  Margins:\n  - BOST Margin\n  - UPPF Margin\n  - Fuel Marking Margin\n  - Primary Distribution Margin\n  - OMC Margin\n  - Dealer Margin\n  \n  Costs:\n  - Transport Cost\n  - Storage Cost\n  - Insurance Cost\n  - Administrative Cost\n  ```\n\n#### 5. Effective Date Ranges and Versioning\n- **Features**:\n  - Automatic version numbering\n  - Overlap detection and validation\n  - Seamless transitions between price versions\n  - Historical price tracking\n  - Future price scheduling\n\n#### 6. API Endpoints\n- **File**: `services/configuration-service/src/configuration/controllers/price-buildup.controller.ts`\n- **Endpoints**:\n  ```\n  POST   /price-buildup/versions              - Create new price version\n  GET    /price-buildup/versions              - List price versions with filtering\n  GET    /price-buildup/versions/:id          - Get specific version\n  PUT    /price-buildup/versions/:id          - Update version\n  POST   /price-buildup/versions/:id/approve  - Approve version\n  POST   /price-buildup/versions/:id/publish  - Publish version\n  POST   /price-buildup/calculate             - Calculate prices\n  GET    /price-buildup/history/:product/:station - Price history\n  POST   /price-buildup/bulk-update           - Bulk price updates\n  POST   /price-buildup/upload-excel          - Excel upload\n  GET    /price-buildup/station-types         - Station configurations\n  GET    /price-buildup/audit-trail           - Audit trail\n  ```\n\n#### 7. Configuration Change Audit Trail\n- **File**: `services/configuration-service/src/configuration/services/configuration-audit.service.ts`\n- **Features**:\n  - Complete audit logging for all changes\n  - Event-driven audit trail updates\n  - Compliance reporting capabilities\n  - User activity tracking\n  - Export capabilities (JSON, CSV)\n\n#### 8. Bulk Upload from Excel\n- **Features**:\n  - Excel template parsing\n  - Data validation and error reporting\n  - Batch processing with rollback capability\n  - Preview mode for validation-only uploads\n  - Support for Ghana price build-up template format\n\n#### 9. Price-build-up Configuration UI\n- **File**: `apps/dashboard/src/pages/pricing/build-up-configuration.tsx`\n- **Features**:\n  - Modern React interface with Framer Motion animations\n  - Three main tabs: Price Versions, Station Types, Approval Workflow\n  - Real-time price calculation display\n  - Component-wise price breakdown\n  - Status tracking and approval management\n  - Responsive design with dark/light theme support\n\n#### 10. Approval Workflow\n- **File**: `services/configuration-service/src/configuration/services/approval-workflow.service.ts`\n- **Features**:\n  - Multi-stage approval process\n  - Role-based approval routing\n  - Escalation and timeout handling\n  - Approval history and statistics\n  - Email notifications (structure ready)\n  - Parallel and sequential approval workflows\n\n#### 11. Thread-safe Operations and Caching\n- **File**: `services/configuration-service/src/configuration/services/thread-safe-config.service.ts`\n- **Features**:\n  - Distributed locking with Redis\n  - Multi-level caching (Local + Redis)\n  - Pessimistic locking for critical updates\n  - Cache optimization and statistics\n  - Batch processing capabilities\n  - Automatic lock cleanup\n\n## Technical Architecture\n\n### Database Schema\n```sql\n-- Price buildup versions with versioning\nCREATE TABLE price_buildup_versions (\n  id UUID PRIMARY KEY,\n  version_number INTEGER,\n  product_type ENUM,\n  effective_date TIMESTAMP,\n  expiry_date TIMESTAMP,\n  status ENUM,\n  total_price DECIMAL(15,4),\n  -- ... additional fields\n);\n\n-- Individual price components\nCREATE TABLE price_components (\n  id UUID PRIMARY KEY,\n  buildup_version_id UUID,\n  component_type ENUM,\n  amount DECIMAL(15,4),\n  is_percentage BOOLEAN,\n  station_type ENUM,\n  -- ... additional fields\n);\n\n-- Station type specific pricing\nCREATE TABLE station_type_pricing (\n  id UUID PRIMARY KEY,\n  buildup_version_id UUID,\n  station_type ENUM,\n  product_type ENUM,\n  final_price DECIMAL(15,4),\n  -- ... breakdown fields\n);\n\n-- Complete audit trail\nCREATE TABLE price_buildup_audit_trail (\n  id UUID PRIMARY KEY,\n  buildup_version_id UUID,\n  action_type VARCHAR(50),\n  action_by VARCHAR(100),\n  action_date TIMESTAMP,\n  old_values JSON,\n  new_values JSON\n);\n```\n\n### Configuration Integration\n```typescript\n// Enhanced configuration entity with price build-up support\nenum ConfigurationModule {\n  STATION_CONFIGURATION = 'STATION_CONFIGURATION',\n  PRICE_COMPONENTS = 'PRICE_COMPONENTS',\n  // ... existing modules\n}\n\n// Thread-safe configuration operations\nclass ThreadSafeConfigurationService {\n  async getConfigurationThreadSafe(key, tenantId, module)\n  async updateConfigurationThreadSafe(id, data, user)\n  async bulkUpdateConfigurationsThreadSafe(updates, user)\n}\n```\n\n### Caching Strategy\n1. **Local Cache**: Fast access for frequently used data (5-minute TTL)\n2. **Redis Cache**: Distributed caching for multi-instance deployments\n3. **Database Cache**: Optimized queries with proper indexing\n4. **Cache Invalidation**: Event-driven invalidation on changes\n\n### Security Features\n1. **Role-based Access Control**: Different permissions for different operations\n2. **Approval Workflows**: Critical changes require approval\n3. **Audit Logging**: Complete trail of all changes\n4. **Data Validation**: Comprehensive validation at all levels\n5. **Thread Safety**: Distributed locking for concurrent operations\n\n## Ghana-Specific Implementation\n\n### Supported Product Types\n- **PETROL**: Premium Petrol (RON 95)\n- **DIESEL**: Gas Oil (Automotive Diesel)\n- **LPG**: Liquefied Petroleum Gas\n- **KEROSENE**: Dual Purpose Kerosene\n- **FUEL_OIL**: Industrial Fuel Oil\n- **AVIATION_FUEL**: Jet A1 Fuel\n- **MARINE_GAS_OIL**: Marine Diesel\n\n### Station Type Configurations\n1. **COCO (Company Owned Company Operated)**\n   - Base Dealer Margin: GHS 0.15\n   - Full company control and compliance\n   - Direct employee operations\n\n2. **DOCO (Dealer Owned Company Operated)**\n   - Base Dealer Margin: GHS 0.20\n   - Shared ownership and operational model\n   - Company operational standards\n\n3. **DODO (Dealer Owned Dealer Operated)**\n   - Base Dealer Margin: GHS 0.25\n   - Independent dealer operations\n   - Brand compliance requirements\n\n4. **INDUSTRIAL**\n   - Base Dealer Margin: GHS 0.05\n   - Large volume industrial customers\n   - Special pricing arrangements\n\n5. **COMMERCIAL**\n   - Base Dealer Margin: GHS 0.10\n   - Fleet and commercial customers\n   - Volume-based pricing\n\n6. **BULK_CONSUMER**\n   - Base Dealer Margin: GHS 0.03\n   - Very large volume consumers\n   - Customized pricing structures\n\n### Ghana Regulatory Components\n- **Energy Debt Recovery Levy**: As per Energy Commission regulations\n- **Road Fund Levy**: Road Fund Act 1997 compliance\n- **Price Stabilization Levy**: Market stabilization mechanism\n- **Special Petroleum Tax**: Government revenue component\n- **Fuel Marking Levy**: Anti-smuggling measures\n\n## Deployment Configuration\n\n### Environment Variables\n```bash\n# Redis Configuration\nREDIS_HOST=localhost\nREDIS_PORT=6379\nREDIS_PASSWORD=your_redis_password\nREDIS_DB=0\n\n# Database Configuration\nDB_HOST=localhost\nDB_PORT=5432\nDB_NAME=omc_erp\nDB_USER=omc_user\nDB_PASSWORD=your_db_password\n\n# Security Configuration\nCONFIG_ENCRYPTION_KEY=your_encryption_key\nJWT_SECRET=your_jwt_secret\n\n# Cache Configuration\nCACHE_TTL_DEFAULT=300\nCACHE_TTL_PRICE=1800\nCACHE_MAX_KEYS=10000\n```\n\n### Performance Optimizations\n1. **Database Indexing**:\n   ```sql\n   CREATE INDEX idx_buildup_effective_date ON price_buildup_versions(effective_date, status);\n   CREATE INDEX idx_components_type_station ON price_components(component_type, station_type);\n   CREATE INDEX idx_audit_date_action ON price_buildup_audit_trail(action_date, action_type);\n   ```\n\n2. **Caching Strategy**:\n   - Price calculations cached for 30 minutes\n   - Configuration values cached for 5 minutes\n   - Station type configs cached for 1 hour\n   - Audit trails not cached (real-time requirement)\n\n3. **Batch Processing**:\n   - Bulk updates processed in batches of 50\n   - Excel uploads validated in chunks\n   - Cache invalidation batched for performance\n\n## API Usage Examples\n\n### Create New Price Version\n```javascript\nPOST /api/price-buildup/versions\n{\n  \"productType\": \"PETROL\",\n  \"effectiveDate\": \"2025-02-01T00:00:00Z\",\n  \"changeReason\": \"Monthly price adjustment\",\n  \"components\": [\n    {\n      \"componentType\": \"EX_REFINERY_PRICE\",\n      \"componentName\": \"Ex-Refinery Price\",\n      \"category\": \"BASE_PRICE\",\n      \"amount\": 11.75,\n      \"currency\": \"GHS\",\n      \"effectiveDate\": \"2025-02-01T00:00:00Z\"\n    },\n    // ... other components\n  ]\n}\n```\n\n### Calculate Price\n```javascript\nPOST /api/price-buildup/calculate\n{\n  \"productType\": \"PETROL\",\n  \"stationType\": \"DODO\",\n  \"calculationDate\": \"2025-01-16T00:00:00Z\",\n  \"includeBreakdown\": true\n}\n\n// Response:\n{\n  \"productType\": \"PETROL\",\n  \"stationType\": \"DODO\",\n  \"totalPrice\": 16.75,\n  \"currency\": \"GHS\",\n  \"breakdown\": [\n    {\n      \"componentType\": \"EX_REFINERY_PRICE\",\n      \"componentName\": \"Ex-Refinery Price\",\n      \"amount\": 11.50,\n      \"category\": \"BASE_PRICE\"\n    },\n    // ... other components\n  ]\n}\n```\n\n### Bulk Update\n```javascript\nPOST /api/price-buildup/bulk-update\n{\n  \"productType\": \"PETROL\",\n  \"effectiveDate\": \"2025-02-01T00:00:00Z\",\n  \"changeReason\": \"Regulatory adjustment\",\n  \"componentUpdates\": [\n    {\n      \"componentType\": \"ROAD_FUND_LEVY\",\n      \"newAmount\": 0.55,\n      \"updateReason\": \"Government increase\"\n    },\n    {\n      \"componentType\": \"ENERGY_DEBT_RECOVERY_LEVY\",\n      \"newAmount\": 0.22,\n      \"updateReason\": \"Quarterly adjustment\"\n    }\n  ]\n}\n```\n\n## Next Steps for Enhancement\n\n1. **Real-time Integration**:\n   - NPA price feed integration\n   - Automatic price updates from external sources\n   - SMS/Email notifications for price changes\n\n2. **Advanced Analytics**:\n   - Price trend analysis\n   - Margin optimization recommendations\n   - Competitive pricing analysis\n\n3. **Mobile Application**:\n   - Price calculator mobile app\n   - Station manager price verification\n   - Real-time price updates\n\n4. **Integration Enhancements**:\n   - ERP system integration\n   - Accounting system automatic journal entries\n   - Dealer portal integration\n\n## Files Created/Modified\n\n### New Files Created:\n1. `services/configuration-service/src/configuration/entities/price-buildup.entity.ts`\n2. `services/configuration-service/src/configuration/dto/price-buildup.dto.ts`\n3. `services/configuration-service/src/configuration/services/price-buildup.service.ts`\n4. `services/configuration-service/src/configuration/services/station-type-config.service.ts`\n5. `services/configuration-service/src/configuration/services/approval-workflow.service.ts`\n6. `services/configuration-service/src/configuration/services/thread-safe-config.service.ts`\n7. `services/configuration-service/src/configuration/controllers/price-buildup.controller.ts`\n8. `apps/dashboard/src/pages/pricing/build-up-configuration.tsx`\n\n### Modified Files:\n1. `services/configuration-service/src/configuration/entities/configuration.entity.ts`\n2. `services/configuration-service/src/configuration/configuration.module.ts`\n3. `services/configuration-service/src/configuration/services/configuration-audit.service.ts`\n\n## Summary\n\nThe comprehensive price build-up configuration system has been successfully implemented with:\n\nâœ… **11/11 Core Features Completed**:\n- Price build-up entities and DTOs with date-based versioning\n- Extended configuration service for price build-up components\n- Station type configuration (COCO, DOCO, DODO, Industrial, Commercial)\n- Complete price build-up component management\n- Effective date ranges and versioning system\n- API endpoints for all price build-up operations\n- Configuration change audit trail system\n- Bulk upload capability from Excel\n- Modern React UI for price-build-up configuration\n- Approval workflow for critical changes\n- Thread-safe operations with caching optimizations\n\nThe system is now ready for production deployment and provides a world-class pricing management solution specifically tailored for Ghana's OMC industry requirements.\n"